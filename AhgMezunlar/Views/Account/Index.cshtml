@{
    ViewData["Title"] = "Hesap";
}


<div class="container d-flex justify-content-end p-0">
    <a data-toggle="tooltip" title="Admin Paneline Git" href="/Admin">
        <i class="fa fa-2x fa-cogs"></i>
    </a>
</div>
<div class="container">

    <button class="accordion">Kullanıcı Listesi</button>
    <div class="panel">
        <table class="userListTable table table-hover table-sm">
            <thead>
                <tr>
                    <th>Email</th>
                    <th class="w-25">Rol</th>
                    <th class="w-10"><i data-toggle="tooltip" title="Düzenlemek için tıklayabilirsiniz" class="fa fa-question-circle-o fa-2x"></i></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td data-user-id="guidveri" class="user-name">baris@bariscanyilmaz</td>
                    <td class="user-role" data-role="2">Kullanıcı</td>
                    <td>
                        <div class="btn btn-danger btn-sm">
                            <i class="fa fa-trash"></i>
                        </div>
                        <div class="btn btn-primary btn-sm">
                            <i class="fa fa-edit"></i>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        <div style="display:flex;flex-direction:row-reverse"><div data-toggle="tooltip" title="Yeni Kullanıcı oluştur" style="margin-right:25px;color:var(--custom-orange);" class="addUser"><i class="fa fa-2x fa-plus-circle"></i></div></div>
    </div>
    <button class="userEditFormPanel accordion">Kullanıcı Oluştur veya Düzenle</button>
    <div class="panel">
        <form id="userEditForm">
            <input type="hidden" id="userid" name="userid" value="" />
            <div class="form-group">
                <label for="email">Email</label>
                <input required class="form-control" id="email" name="email" type="email">
            </div>
            <div class="form-group">
                <label for="password">Şifre</label>
                <input type="password" class="form-control" name="password" id="password" placeholder="Min 7 Karakter. Türkçe Karakter İçermesin">
            </div>
            <div class="form-group">
                <select name="role" class="custom-select" id="role" required>
                    <option selected disabled>Kullanıcı Yetki Derecesi Seçiniz</option>
                    <option value="Admin">Admin</option>
                    <option value="User">User</option>
                </select>
            </div>
            <input type="button" class="btn btn-primary" value="Kaydet">
        </form>
    </div>
</div>

<!--Sections-->
@section scripts{
<script>
    //email valid pattern
    function isValidEmailAddress(emailAddress) {
        var pattern = /^([a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+(\.[a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)*|"((([ \t]*\r\n)?[ \t]+)?([\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*(([ \t]*\r\n)?[ \t]+)?")@@(([a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.)+([a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.?$/i;
        return pattern.test(emailAddress);
    }


    $('.panel').on('click', '.addUser ', function () {
        $('.userEditFormPanel').click();

        $('#email').val('');
        $('#userid').val('');
        $('#role').val('Kullanıcı Yetki Derecesi Seçiniz');

    });

    var accordion = document.getElementsByClassName("accordion");
    var i;
    for (i = 0; i < accordion.length; i++) {
        accordion[i].addEventListener('click', function () {
            this.classList.toggle('active');

            var panel = this.nextElementSibling;
            if (panel.style.maxHeight) {
                panel.style.maxHeight = null;
                panel.classList.toggle('m-3');
            } else {
                panel.style.maxHeight = panel.scrollHeight + 'px';
                panel.classList.toggle('m-3');
            }

        });

    }


    var navLinks = document.getElementsByClassName('nav-link');
    var tabContentList = document.getElementsByClassName('tab-pane');

    $('.nav-item a').click(function () {
        var targetId = $(this).data('pill').replace('#', '');
        openTab(targetId);
    })

    function openTab(tabpaneid) {
        for (let i = 0; i < tabContentList.length; i++) {
            tabContentList[i].style.display = 'none';
        }

        element = document.getElementById(tabpaneid);
        element.style.display = 'flex';
    }

    $('.userListTable').on('click', '.btn-primary', function (e) {
        let row = $(this).closest('tr');
        let id = row.find('.user-name').data('user-id');
        let userName = row.find('.user-name').text();
        let role = row.find('.user-role').text();

        $('#email').val(userName);
        $('#role').val(role);
        $('#userid').val(id);
        
        e.stopImmediatePropagation();
        e.preventDefault();
    });

    $('.userListTable').on('click', '.btn-danger', function (e) {
        let row = $(this).closest('tr');
        let id = row.find('.user-name').data('user-id');

        $.post('/Account/DeleteUser', 'id=' + id, function (returnVal) {
            if (returnVal == 1) {
                row.remove();
            } 
        })

        e.stopImmediatePropagation();
        e.preventDefault();
    })

    $('#userEditForm').on('click', '.btn-primary', function (e) {
        var data = $('#userEditForm').serialize();
        let email = $('#email').val()
        let role = $('#role').val();
        
        console.log(role);
        if (email.length > 0 && isValidEmailAddress(email)) {
            if (role != null) {
                $.post('/Account/SaveUser', data, function (returnVal) {
                    if (returnVal == 1) {

                        $('#email').val('');
                        $('#role').val('');
                        $('#userid').val('');
                        $('#password').val('');
                        $('#role').val('Kullanıcı Yetki Derecesi Seçiniz');
                        GetAllUsers();

                    } else {
                        alert('hata oluştu lütfen daha sonra tekrar deneyiniz');

                        $('#email').val('');
                        $('#role').val('');
                        $('#userid').val('');
                        $('#password').val('');
                        $('#role').val('Kullanıcı Yetki Derecesi Seçiniz');

                    }
                });
            } else {
                alert('Lütfen rol seçiniz.');
            }
        } else {
            alert('Lütfen geçerli bir email giriniz. ')

        }


    });

    //GetAllUsers
    function GetAllUsers() {
        $.get('/Account/GetAllUsers', function (returnVal) {
            if (returnVal.length > 0) {
                $('.userListTable tbody tr').remove();
                $.each(returnVal, function (index, value) {
                    $('.userListTable tbody').append(`<tr>
                                <td data-user-id="${value.id}" class="user-name">${value.email}</td>
                                <td class="user-role">${value.role}</td>
                                <td>
                                    <div style="display:${value.role == 'Admin' ? 'none' : ''}" class="btn btn-danger btn-sm">
                                        <i class="fa fa-trash"></i>
                                    </div>
                                    <div class="btn btn-primary btn-sm">
                                        <i class="fa fa-edit"></i>
                                    </div>
                                </td>
                            </tr>`);
                });
            };
        });
    }

    $(document).ready(function () {
        GetAllUsers();
    });

</script>


}

